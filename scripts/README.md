# Utility Scripts for Evaluation

This folder contains some scripts for reproducing the evaluation results and some utility scripts.

* `build.sh`: building the Occlum Rust target (`musl`).
* `clean_data.sh`: clean the evaluation data and intermediate files.
* `plt_cost_breakup.ipynb`: plot the result of the cost breakup.
* `plt_db.ipynb`: plot the figure for YCSB KVDB result.
* `plt_main.ipynb`: plot the figures for polybench, tvm, fasta tasks.
* `plt_stack.ipynb`: plot the figure for stack page number.
* `demo-verify.sh`: run the PoBF verifier on a demo CC task.
* `evaluation.sh`: run the evaluation tasks for polybench, TVM, FASTA and identity task.
* `multi_threading.sh`: run the evaluation tasks in multi-threaded mode. This script is not intended for separate use.
* `prepare_prusti.sh`: Install the Prusti toolchain.
* `prepare_mirai.sh`: Install the MIRAI abstract interpreter.

## How to reproduce evaluation results?

### Microbenchmarks

* Cost breakup: Follow these steps:

  ```sh
  # OR sev
  cd platform_sgx && SGX_MODE=HW TASK=task_none make -j
  cd bin && ./app 127.0.0.1 1234 >> output.txt &

  # Then run the data provider.
  cd ../../data_provider && make -j
  # Note that manifest.json's data path should contain the input dummy data which can be generated using scripts/data_generator
  cd bin && ./data_provider run ../manifest.json

  # Then you modify manifest.json to set the data path to another one until all input data is used.
  ```

  The input data can be generated by

  ```sh
  $ cd scripts/data_generator
  $ cargo r -r -- --help
  Usage: data_generator [OPTIONS]

  Options:
    -l, --len <LEN>                  Data sizes you want to run [default: 1000]
    -o, --output-path <OUTPUT_PATH>  The output path [default: output.bin]
    -h, --help                       Print help
    -V, --version                    Print version
  ```

  Open `plt_cost_breakup.ipynb` and change the output file path (`output.txt`). Then you should see the result. You will see something like

  ```txt
  [2023-06-12T12:17:32Z INFO  app::ocall] [+] Enclave: Job finished. Time used: 28.058968731s; breakup {"decrypt_data": 74482.66857142857, "do_compute": 0.319047619047619, "encrypt_result": 98212.00952380952, "establish_channel": 121811.60666666667, "receive_data": 27763494.36095238}
  ```

  in the output.

* Evaluate the effect of zeroization using different page numbers.

  ```sh
  # Rebuild the enclave.
  SGX_MODE=HW TASK=task_none,native_zeroize  make -j
  cd bin && ./app 127.0.0.1 1234 [set this to page number] &

  # Run the data provider.
  cd ../../data_provider/bin
  ./data_provider run ./manifest.json
  ```

  Then you should get the service time. Run 10 times and get the average value. Manually feed these data to `plt_stack.ipynb` and you will get the visualized result.

  We apologize that there is no convenient way to automate this process.

* Evaluate the polybench.

  First modify `./evaluations.sh`:

  ```sh
  # Make sure tasks only contain polybench.
  declare -a tasks=("task_polybench")
  ```

  ```sh
  # There is no multi-threading for this task. So th thread num is simply set to 1.
  cd scripts && ./evaluation.sh 1 pobf # or sev
  ```

  It takes some time to build enclaves. Please be patient while the script is building and running the enclave.
